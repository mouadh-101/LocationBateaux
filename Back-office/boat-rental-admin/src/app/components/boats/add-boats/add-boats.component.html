<h2 class="form-title">Ajouter un bateau</h2>

<button type="button" class="btn-secondary flex-1" (click)="goBack()">Retour à la liste</button>

<div class="card-form">
  <form #form="ngForm" (ngSubmit)="saveBoat()" class="form-card" novalidate>

    <!-- Step 1: Informations générales + Images -->
    <div *ngIf="isStep(1)">
      <h3>Informations du bateau</h3>

      <label for="nom">Nom du bateau</label>
      <input type="text" id="nom" [(ngModel)]="boat.nom" name="nom" #nom="ngModel" required minlength="3"
        maxlength="50" />
      <div *ngIf="nom.invalid && nom.touched" class="error-msg">
        <small *ngIf="nom.errors?.['required']">Le nom est obligatoire.</small>
        <small *ngIf="nom.errors?.['minlength']">Minimum 3 caractères.</small>
        <small *ngIf="nom.errors?.['maxlength']">Maximum 50 caractères.</small>
      </div>

      <label for="description">Description</label>
      <textarea id="description" [(ngModel)]="boat.description" name="description" #description="ngModel" required
        minlength="10" maxlength="300"></textarea>
      <div *ngIf="description.invalid && description.touched" class="error-msg">
        <small *ngIf="description.errors?.['required']">La description est obligatoire.</small>
        <small *ngIf="description.errors?.['minlength']">Minimum 10 caractères.</small>
        <small *ngIf="description.errors?.['maxlength']">Maximum 300 caractères.</small>
      </div>

      <label for="prix">Prix (€)</label>
      <input type="number" id="prix" [(ngModel)]="boat.prix" name="prix" #prix="ngModel" min="0" required />
      <div *ngIf="prix.invalid && prix.touched" class="error-msg">
        <small *ngIf="prix.errors?.['required']">Le prix est obligatoire.</small>
        <small *ngIf="prix.errors?.['min']">Le prix doit être positif ou nul.</small>
      </div>

      <div *ngIf="admin">
        <label for="commission">Commission %</label>
        <input type="number" id="commission" [(ngModel)]="boat.commission" name="commission" #commission="ngModel"
          min="0" />
      </div>

      <label for="port">Port</label>
      <select id="port" [(ngModel)]="selectedPort" name="port" #port="ngModel" required (change)="onPortChange()">
        <option *ngFor="let p of ports" [value]="p.nom">{{ p.nom }}</option>
        <option value="autre">Autre</option>
      </select>
      <div *ngIf="selectedPort === 'autre'">
        <input type="text" [(ngModel)]="boat.port.nom" name="newPort" #newPort="ngModel" required minlength="2"
          maxlength="50" />

        <div *ngIf="newPort.invalid && newPort.touched" class="error-msg">
          <small *ngIf="newPort.errors?.['required']">Le port est obligatoire.</small>
          <small *ngIf="newPort.errors?.['minlength']">Minimum 2 caractères.</small>
          <small *ngIf="newPort.errors?.['maxlength']">Maximum 50 caractères.</small>
        </div>
      </div>


    </div>

    <!-- Step 2: Caractéristiques -->
    <div *ngIf="isStep(2)">
      <h3>Caractéristiques du bateau</h3>

      <fieldset class="caracteristique-section">
        <legend>Détails techniques</legend>

        <label for="capacite">Capacité</label>
        <input type="number" id="capacite" [(ngModel)]="boat.carecteristique.capacite" name="caracteristique.capacite"
          #capacite="ngModel" min="1" required />
        <div *ngIf="capacite.invalid && capacite.touched" class="error-msg">
          <small *ngIf="capacite.errors?.['required']">La capacité est obligatoire.</small>
          <small *ngIf="capacite.errors?.['min']">Doit être au moins 1.</small>
        </div>

        <label for="longueur">Longueur (m)</label>
        <input type="number" step="0.1" id="longueur" [(ngModel)]="boat.carecteristique.longueur"
          name="caracteristique.longueur" #longueur="ngModel" min="0.1" required />
        <div *ngIf="longueur.invalid && longueur.touched" class="error-msg">
          <small *ngIf="longueur.errors?.['required']">La longueur est obligatoire.</small>
          <small *ngIf="longueur.errors?.['min']">Doit être positive.</small>
        </div>

        <label for="largeur">Largeur (m)</label>
        <input type="number" step="0.1" id="largeur" [(ngModel)]="boat.carecteristique.largeur"
          name="caracteristique.largeur" #largeur="ngModel" min="0.1" required />
        <div *ngIf="largeur.invalid && largeur.touched" class="error-msg">
          <small *ngIf="largeur.errors?.['required']">La largeur est obligatoire.</small>
          <small *ngIf="largeur.errors?.['min']">Doit être positive.</small>
        </div>

        <label for="nombreMoteurs">Nombre de moteurs</label>
        <input type="number" id="nombreMoteurs" [(ngModel)]="boat.carecteristique.nombreMoteurs"
          name="caracteristique.nombreMoteurs" #nombreMoteurs="ngModel" min="0" required />
        <div *ngIf="nombreMoteurs.invalid && nombreMoteurs.touched" class="error-msg">
          <small *ngIf="nombreMoteurs.errors?.['required']">Le nombre de moteurs est obligatoire.</small>
          <small *ngIf="nombreMoteurs.errors?.['min']">Ne peut pas être négatif.</small>
        </div>

        <label for="type">Type de bateau</label>
        <select id="type" [(ngModel)]="boat.carecteristique.type" name="caracteristique.type" #type="ngModel" required
          class="w-full px-4 py-2 rounded-lg border-2 border-indigo-400 bg-gradient-to-r from-indigo-100 to-indigo-50 text-indigo-900 shadow-md hover:border-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300 ease-in-out cursor-pointer">
          <option value="" disabled>-- Choisir un type --</option>
          <option value="YACHT">Yacht</option>
          <option value="VOILIER">Voilier</option>
          <option value="CATAMARAN">Catamaran</option>
          <option value="SPORT">Sport</option>
          <option value="AUTRE">Autre</option>
        </select>
        <div *ngIf="type.invalid && type.touched" class="error-msg">
          <small>Le type de bateau est obligatoire.</small>
        </div>
      </fieldset>
    </div>

    <!-- Step 3: Services -->
    <div *ngIf="isStep(3)">
      <h3>Services disponibles</h3>

      <label><strong>Sélectionnez les services inclus</strong></label><br>

      <div class="checkbox-group">
        <label *ngFor="let service of servicesDisponibles">
          <input type="checkbox" [checked]="isServiceSelected(service)" (change)="toggleService(service)" />
          {{ service.nom }}
        </label>
      </div>

      <!-- Add new service -->
      <div class="add-service mt-3">
        <label for="newService">Ajouter un nouveau service</label>
        <input type="text" id="newService" [(ngModel)]="newServiceName" name="newServiceName" />
        <button type="button" class="btn-secondary ml-2" (click)="addNewService()">Ajouter</button>
      </div>
    </div>

    <!-- Step 4: Pricing & Reservation Settings -->
    <div *ngIf="isStep(4)">
      <h3>Types de réservation et tarifs</h3>

      <fieldset class="reservation-types-section">
        <label><strong>Types de réservation disponibles</strong></label><br>

        <!-- Journée complète -->
        <label>
          <input type="checkbox" [(ngModel)]="boat.reservationTypeSettings.full_day_enabled"
            name="reservation.fullDay" />
          <span>Journée complète</span>
        </label>
        <div *ngIf="boat.reservationTypeSettings.full_day_enabled">
          <input type="number" [(ngModel)]="boat.reservationTypeSettings.fullDayPrice"
            placeholder="Prix pour une journée complète (TND)" name="reservation.fullDayPrice" class="form-control"
            min="0" required />
        </div>

        <!-- Demi-journée -->
        <label>
          <input type="checkbox" [(ngModel)]="boat.reservationTypeSettings.half_day_enabled"
            name="reservation.halfDay" />
          <span>Demi-journée</span>
        </label>
        <div *ngIf="boat.reservationTypeSettings.half_day_enabled">
          <input type="number" [(ngModel)]="boat.reservationTypeSettings.halfDayPrice"
            placeholder="Prix pour une demi-journée (TND)" name="reservation.halfDayPrice" class="form-control" min="0"
            required />
        </div>

        <!-- 2 heures -->
        <label>
          <input type="checkbox" [(ngModel)]="boat.reservationTypeSettings.two_hours_enabled"
            name="reservation.twoHours" />
          <span>2 heures</span>
        </label>
        <div *ngIf="boat.reservationTypeSettings.two_hours_enabled">
          <input type="number" [(ngModel)]="boat.reservationTypeSettings.twoHoursPrice"
            placeholder="Prix pour 2 heures (TND)" name="reservation.twoHoursPrice" class="form-control" min="0"
            required />
        </div>
      </fieldset>

    </div>
    <div *ngIf="isStep(5)">
      <h3>les Image de Bateuax</h3>
      <app-image-upload [initialImages]="boat.images" #imageUploader></app-image-upload>

    </div>

    <!-- Navigation Buttons -->
    <div class="form-actions flex gap-4 mt-6">
      <button type="button" *ngIf="step > 1" class="btn-secondary" (click)="prevStep()">Précédent</button>

      <button type="button" *ngIf="step < 5" class="btn-primary" (click)="nextStep()" [disabled]="!isFormStepValid()">
        Suivant
      </button>
      <button *ngIf="step === 5" type="submit" class="btn-primary flex-1" [disabled]="form.invalid">
        Enregistrer
      </button>
    </div>

  </form>
</div>